<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>AI ì‹ë‹¨ ì¶”ì²œ</title>
    <style>
        body {
            font-family: 'Segoe UI', sans-serif;
            max-width: 700px;
            margin: auto;
            padding: 20px;
            background-color: #e8eaea;
            color: #2c2c2c;
        }

        h1 {
            text-align: center;
            font-size: 2.2rem;
            padding: 20px;
            margin-bottom: 30px;
            color: #fff;
            background: linear-gradient(135deg, #4a4a4a, #5e5e5e);
            border-radius: 12px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        input, select, textarea, button {
            width: 100%;
            padding: 10px;
            margin-top: 8px;
            box-sizing: border-box;
            border: 1px solid #b0b0b0;
            border-radius: 6px;
            font-size: 1rem;
            background-color: #fff;
            color: #333;
            transition: all 0.2s ease-in-out;
        }

        input:focus, select:focus, textarea:focus {
            border-color: #888;
            outline: none;
            box-shadow: 0 0 4px rgba(100, 100, 100, 0.2);
        }

        input:disabled, select:disabled {
            background-color: #f0f0f0;
            color: #888;
        }

        label {
            display: block;
            margin-top: 20px;
            font-weight: bold;
            color: #444;
        }

        button {
            background-color: #555;
            color: #fff;
            border: none;
            cursor: pointer;
            margin-top: 20px;
            font-weight: bold;
            transition: background-color 0.3s ease;
        }

        button:hover {
            background-color: #707070;
        }

        textarea {
            resize: vertical;
        }

        .inline {
            display: flex;
            gap: 10px;
        }

        .inline > div {
            flex: 1;
        }

        #loading {
            display: none;
            text-align: center;
            margin-top: 30px;
            color: #555;
        }

        .loader {
            border: 6px solid #ccc;
            border-top: 6px solid #666;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: auto;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }
            100% {
                transform: rotate(360deg);
            }
        }
    </style>
</head>
<body>
    <h1>ğŸ¤– AI ë§ì¶¤ ì‹ë‹¨ ì¶”ì²œ ğŸ¤–</h1>
    <form id="dietForm">
        <label>ëª©ì </label>
        <select name="goal" id="goal" required>
            <option value="">ëª©ì ì„ ê³¨ë¼ì£¼ì„¸ìš”.</option>
            <option value="ë‹¤ì´ì–´íŠ¸">ë‹¤ì´ì–´íŠ¸</option>
            <option value="ìœ ì§€">ìœ ì§€</option>
            <option value="ë¦°ë§¤ìŠ¤ì—…">ë¦°ë§¤ìŠ¤ì—…</option>
            <option value="ë²Œí¬ì—…">ë²Œí¬ì—…</option>
        </select>

        <label>ì„±ë³„</label>
        <select name="gender">
            <option value="ë‚¨">ë‚¨</option>
            <option value="ì—¬">ì—¬</option>
            <option value="">ì…ë ¥í•˜ì§€ ì•ŠìŒ</option>
        </select>

        <div class="inline">
            <div>
                <label>ë‚˜ì´ (ë§Œ)</label>
                <input type="number" name="age" required min="1"/>
            </div>
            <div>
                <label>í‚¤ (cm)</label>
                <input type="number" name="height" required min="1"/>
            </div>
        </div>

        <label>ëª¸ë¬´ê²Œ (kg)</label>
        <input type="number" name="weight" required min="1"/>

        <label>ê¸°ì´ˆëŒ€ì‚¬ëŸ‰ ì…ë ¥ ë°©ì‹</label>
        <select name="bmrMode" id="bmrMode">
            <option value="manual" selected>ì§ì ‘ ì…ë ¥</option>
            <option value="auto">ëª¨ë¦„ (ìë™ ê³„ì‚°)</option>
        </select>

        <div id="bmr-manual-group">
            <label>ê¸°ì´ˆëŒ€ì‚¬ëŸ‰ (BMR ì§ì ‘ ì…ë ¥)</label>
            <input type="number" name="bmrManual" required min="1"/>
        </div>
        <div id="bmr-auto-group" style="display:none;">
            <label>ê³„ì‚°ëœ ê¸°ì´ˆëŒ€ì‚¬ëŸ‰ (BMR)</label>
            <input type="number" name="bmrAuto" id="bmr-auto" readonly/>
        </div>

        <div class="inline">
            <div>
                <label>ì²´ì§€ë°©ëŸ‰ (kg)</label>
                <input type="number" name="fatMass"/>
            </div>
            <div>
                <label>ì²´ì§€ë°© ìˆ˜ì¤€</label>
                <select name="fatLevel">
                    <option value="">ì„ íƒ ì•ˆ í•¨</option>
                    <option value="ìƒ">ìƒ</option>
                    <option value="ì¤‘ìƒ">ì¤‘ìƒ</option>
                    <option value="ì¤‘">ì¤‘</option>
                    <option value="ì¤‘í•˜">ì¤‘í•˜</option>
                    <option value="í•˜">í•˜</option>
                </select>
            </div>
        </div>

        <div class="inline">
            <div>
                <label>ê·¼ìœ¡ëŸ‰ (kg)</label>
                <input type="number" name="muscleMass"/>
            </div>
            <div>
                <label>ê·¼ìœ¡ ìˆ˜ì¤€</label>
                <select name="muscleLevel">
                    <option value="">ì„ íƒ ì•ˆ í•¨</option>
                    <option value="ìƒ">ìƒ</option>
                    <option value="ì¤‘ìƒ">ì¤‘ìƒ</option>
                    <option value="ì¤‘">ì¤‘</option>
                    <option value="ì¤‘í•˜">ì¤‘í•˜</option>
                    <option value="í•˜">í•˜</option>
                </select>
            </div>
        </div>

        <div class="inline">
            <div>
                <label>í•˜ë£¨ í™œë™ ì¹¼ë¡œë¦¬ (kcal)</label>
                <input type="number" name="activityCal"/>
            </div>
            <div>
                <label>í™œë™ ìˆ˜ì¤€</label>
                <select name="activityLevel">
                    <option value="">ì„ íƒ ì•ˆ í•¨</option>
                    <option value="ìƒ">ìƒ</option>
                    <option value="ì¤‘ìƒ">ì¤‘ìƒ</option>
                    <option value="ì¤‘">ì¤‘</option>
                    <option value="ì¤‘í•˜">ì¤‘í•˜</option>
                    <option value="í•˜">í•˜</option>
                </select>
            </div>
        </div>

        <div id="target-group">
            <label>ëª©í‘œ ì²´ì¤‘ (kg)</label>
            <input type="number" name="targetWeight"/>

            <label>ëª©í‘œ ì²´ì§€ë°©ëŸ‰ (kg)</label>
            <input type="number" name="targetFat"/>

            <label>ëª©í‘œ ê·¼ìœ¡ëŸ‰ (kg)</label>
            <input type="number" name="targetMuscle"/>
        </div>

        <label>ëª©í‘œ ì¼ìˆ˜</label>
        <input type="number" name="days" required min="1"/>

        <label>ë¨¹ê³  ì‹¶ì€ ìŒì‹ (ì‰¼í‘œë¡œ êµ¬ë¶„)</label>
        <textarea name="preferences" rows="3" placeholder="ì˜ˆ) ì œìœ¡ë³¶ìŒ, ì†Œë¶ˆê³ ê¸°, ë‹­ë³¶ìŒíƒ•"></textarea>

        <button type="submit">AIì—ê²Œ ì‹ë‹¨ ìš”ì²­í•˜ê¸° ğŸ½ï¸</button>
    </form>

    <div id="errorBox" style="color: red; margin-top: 20px;"></div>

    <div id="loading">
        <div class="loader"></div>
        <p>AIê°€ ì‹ë‹¨ì„ ì‘ì„± ì¤‘ì…ë‹ˆë‹¤...</p>
    </div>

    <div id="result"></div>

    <script>
        // âœ… Gemini API í‚¤ì™€ ìš”ì²­ URL ì •ì˜
        const API_KEY = '';
        const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${API_KEY}`;

        // âœ… DOM ìš”ì†Œ ì°¸ì¡°
        const form = document.getElementById('dietForm');
        const resultDiv = document.getElementById('result'); // ê²°ê³¼ ì¶œë ¥ ì˜ì—­
        const bmrSelect = document.getElementById('bmrMode'); // BMR ì…ë ¥ ë°©ì‹ ì…€ë ‰íŠ¸ ë°•ìŠ¤
        const bmrManual = form.bmrManual; // ìˆ˜ë™ ì…ë ¥ BMR í•„ë“œ
        const bmrAuto = form.bmrAuto; // ìë™ ê³„ì‚°ëœ BMR í•„ë“œ
        const autoGroup = document.getElementById('bmr-auto-group'); // ìë™ BMR í•„ë“œ ì˜ì—­
        const manualGroup = document.getElementById('bmr-manual-group'); // ìˆ˜ë™ BMR í•„ë“œ ì˜ì—­
        const errorBox = document.getElementById('errorBox'); // ì˜¤ë¥˜ ë©”ì‹œì§€ í‘œì‹œ ì˜ì—­
        const loading = document.getElementById('loading'); // ë¡œë”© ì¸ë””ì¼€ì´í„° ì˜ì—­

        // âœ… í•˜ë‚˜ ì…ë ¥ë˜ë©´ ë‹¤ë¥¸ í•˜ë‚˜ëŠ” ë¹„í™œì„±í™”ë˜ëŠ” ìŒ ì…ë ¥ êµ¬ì„± í•¨ìˆ˜
        function setupExclusiveInput(primaryInput, secondarySelect) {
            primaryInput.addEventListener('input', () => {
                if (primaryInput.value) {
                    secondarySelect.disabled = true;
                    secondarySelect.value = ''; // ì…€ë ‰íŠ¸ ì´ˆê¸°í™”
                } else {
                    secondarySelect.disabled = false;
                }
            });

            secondarySelect.addEventListener('change', () => {
                if (secondarySelect.value !== '') {
                    primaryInput.disabled = true;
                    primaryInput.value = ''; // ì…ë ¥ ì´ˆê¸°í™”
                } else {
                    primaryInput.disabled = false;
                }
            });
        }

        // âœ… ì²´ì§€ë°©ëŸ‰ â†” ì²´ì§€ë°© ìˆ˜ì¤€, ê·¼ìœ¡ëŸ‰ â†” ê·¼ìœ¡ ìˆ˜ì¤€, í™œë™ ì¹¼ë¡œë¦¬ â†” í™œë™ ìˆ˜ì¤€ ìŒ ì—°ê²°
        setupExclusiveInput(form.fatMass, form.fatLevel);
        setupExclusiveInput(form.muscleMass, form.muscleLevel);
        setupExclusiveInput(form.activityCal, form.activityLevel);

        // âœ… ìë™ BMR ê³„ì‚° í•¨ìˆ˜ (Mifflin-St Jeor ê³µì‹ ê¸°ë°˜)
        const calculateBMR = () => {
            const gender = form.gender.value;
            const age = +form.age.value;
            const height = +form.height.value;
            const weight = +form.weight.value;
            if (!age || !height || !weight) return;
            let bmr = 0;
            if (gender === 'ë‚¨') {
                bmr = 66.47 + 13.75 * weight + 5.003 * height - 6.755 * age;
            } else if (gender === 'ì—¬') {
                bmr = 655.1 + 9.563 * weight + 1.85 * height - 4.676 * age;
            } else {
                const male = 66.47 + 13.75 * weight + 5.003 * height - 6.755 * age;
                const female = 655.1 + 9.563 * weight + 1.85 * height - 4.676 * age;
                bmr = (male + female) / 2;
            }
            bmrAuto.value = Math.round(bmr);
        };

        // âœ… BMR ì…ë ¥ ë°©ì‹ ë³€ê²½ ì‹œ ë³´ì—¬ì¤„ í•„ë“œ ì „í™˜
        bmrSelect.addEventListener('change', () => {
            const isAuto = bmrSelect.value === 'auto';
            autoGroup.style.display = isAuto ? 'block' : 'none';
            manualGroup.style.display = isAuto ? 'none' : 'block';
            bmrManual.required = !isAuto;
            bmrAuto.required = isAuto;
            if (isAuto) calculateBMR();
        });

        // âœ… ìë™ ê³„ì‚° ì¡°ê±´ ê°’ì´ ë³€ê²½ë˜ë©´ ì‹¤ì‹œê°„ BMR ê³„ì‚°
        ['gender', 'age', 'height', 'weight'].forEach(name => {
            form[name].addEventListener('input', calculateBMR);
        });

        // âœ… ì œì¶œ ì‹œ ì‹¤í–‰ë  ì „ì²´ ë¡œì§
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            loading.style.display = 'block';
            errorBox.innerHTML = '';
            resultDiv.innerHTML = '';
            const data = Object.fromEntries(new FormData(form).entries());
            const errorMessages = [];
            let firstInvalidField = null;

            if (typeof data.preferences !== 'string') data.preferences = 'ì—†ìŒ';
            if (!data.age || +data.age <= 0) {
                errorMessages.push('ë‚˜ì´');
                firstInvalidField = firstInvalidField || form.age;
            }
            if (!data.height || +data.height <= 0) {
                errorMessages.push('í‚¤');
                firstInvalidField = firstInvalidField || form.height;
            }
            if (!data.weight || +data.weight <= 0) {
                errorMessages.push('ëª¸ë¬´ê²Œ');
                firstInvalidField = firstInvalidField || form.weight;
            }
            if (data.bmrMode === 'manual') {
                if (!data.bmrManual || +data.bmrManual <= 0) {
                    errorMessages.push('ê¸°ì´ˆëŒ€ì‚¬ëŸ‰(BMR)');
                    firstInvalidField = firstInvalidField || form.bmrManual;
                }
            } else {
                if (!data.bmrAuto || +data.bmrAuto <= 0) {
                    errorMessages.push('ìë™ ê³„ì‚°ëœ BMR');
                    firstInvalidField = firstInvalidField || form.bmrAuto;
                }
            }
            if (!data.fatMass && !data.fatLevel) errorMessages.push('ì²´ì§€ë°©ëŸ‰ ë˜ëŠ” ì²´ì§€ë°© ìˆ˜ì¤€');
            if (!data.muscleMass && !data.muscleLevel) errorMessages.push('ê·¼ìœ¡ëŸ‰ ë˜ëŠ” ê·¼ìœ¡ ìˆ˜ì¤€');
            if (!data.activityCal && !data.activityLevel) errorMessages.push('í™œë™ ì¹¼ë¡œë¦¬ ë˜ëŠ” í™œë™ ìˆ˜ì¤€');
            if (!data.days || +data.days <= 0) {
                errorMessages.push('ëª©í‘œ ì¼ìˆ˜');
                firstInvalidField = firstInvalidField || form.days;
            }

            if (errorMessages.length > 0) {
                alert('ì‘ì„±ë˜ì§€ ì•Šì€ í•­ëª©ì´ ìˆìŠµë‹ˆë‹¤:\n- ' + errorMessages.join('\n- '));
                if (firstInvalidField) firstInvalidField.focus();
                return;
            }

            // âœ… GPT í”„ë¡¬í”„íŠ¸ ìƒì„±
            const prompt =
                `ë‹¹ì‹ ì€ ì „ë¬¸ íŠ¸ë ˆì´ë„ˆì´ì ì˜ì–‘ì‚¬ì…ë‹ˆë‹¤. ì‚¬ìš©ìì˜ ê±´ê°• ì •ë³´ì™€ ëª©í‘œë¥¼ ë°”íƒ•ìœ¼ë¡œ ì‹ë‹¨ê³¼ ì „ëµì„ JSON êµ¬ì¡°ì™€ HTML ì¹´ë“œ ë·° í˜•ì‹ìœ¼ë¡œ ì‘ì„±í•´ì£¼ì„¸ìš”.\n` +
                `ìš”ì²­ì‚¬í•­:\n1. í•˜ë£¨ 3ë¼ ì‹ë‹¨ + ë ˆì‹œí”¼\n2. HTML ì¹´ë“œë·° ë˜ëŠ” JSON\n3. ì „ëµ ë¶„ì„ í¬í•¨\n4. ì£¼ë‹¹ ì²´ì¤‘ ë³€í™”ëŸ‰ í¬í•¨\n5. 7ì¼ ì´ìƒì´ë©´ ë°˜ë³µ ì•ˆë‚´\n6. ìš”ì•½ + ìì„¸íˆ ë³´ê¸°\n7. ëª©í‘œì— ë”°ë¥¸ ìë™ ì „ëµ\n8. ë¨¹ê³  ì‹¶ì€ ìŒì‹ ë°˜ì˜\n9. HTML ì¹´ë“œ í˜•ì‹ìœ¼ë¡œë§Œ ì¶œë ¥\n10. ì²´ì¤‘ ë³€í™” ì˜ˆì¸¡ ë¬¸êµ¬ í¬í•¨\n\n` +
                `[ì‚¬ìš©ì ì •ë³´]\n` +
                `ì„±ë³„: ${data.gender || 'ì…ë ¥í•˜ì§€ ì•ŠìŒ'}\në‚˜ì´: ${data.age}\ní‚¤: ${data.height}cm\nëª¸ë¬´ê²Œ: ${data.weight}kg\n` +
                `ì²´ì§€ë°©ëŸ‰: ${data.fatMass || data.fatLevel}\nê·¼ìœ¡ëŸ‰: ${data.muscleMass || data.muscleLevel}\n` +
                `ê¸°ì´ˆëŒ€ì‚¬ëŸ‰: ${data.bmrMode === 'auto' ? data.bmrAuto : data.bmrManual}kcal\n` +
                `í™œë™ ì¹¼ë¡œë¦¬: ${data.activityCal || data.activityLevel}\n` +
                `ëª©í‘œ ì²´ì¤‘: ${data.targetWeight}kg, ëª©í‘œ ì²´ì§€ë°©: ${data.targetFat}kg, ëª©í‘œ ê·¼ìœ¡: ${data.targetMuscle}kg\n` +
                `ëª©í‘œ ì¼ìˆ˜: ${data.days}ì¼\n` +
                `ë¨¹ê³  ì‹¶ì€ ìŒì‹: ${data.preferences || 'ì—†ìŒ'}\n` +
                `â€» ë°˜ë“œì‹œ HTML íƒœê·¸(div, section ë“±)ë§Œ ì‚¬ìš©í•˜ê³  ì½”ë“œë¸”ëŸ­(\`\`\`)ì´ë‚˜ ì„¤ëª… í…ìŠ¤íŠ¸ëŠ” ê¸ˆì§€í•˜ì„¸ìš”.`;

            try {
                const res = await fetch(API_URL, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({contents: [{role: 'user', parts: [{text: prompt}]}]})
                });

                const json = await res.json();
                let raw = json.candidates?.[0]?.content?.parts?.[0]?.text || 'ê²°ê³¼ ì—†ìŒ';

                // âœ… ì½”ë“œë¸”ëŸ­ ë§ˆí¬ë‹¤ìš´ ì œê±°
                if (raw.startsWith('```')) raw = raw.replace(/^```(html|json)?\n/, '').replace(/```$/, '');

                // âœ… HTML ì‘ë‹µ ì²˜ë¦¬
                if (raw.includes('<div') || raw.includes('<section')) {
                    resultDiv.innerHTML = raw;
                } else if (raw.trim().startsWith('{') && raw.trim().endsWith('}')) {
                    try {
                        const parsed = JSON.parse(raw);
                        renderCard(parsed);
                    } catch (e) {
                        resultDiv.innerHTML = `<pre>${raw}</pre>`;
                    }
                } else {
                    resultDiv.innerHTML = `<pre>${raw}</pre>`;
                }
            } catch (err) {
                console.error('ì—ëŸ¬ ë‚´ìš©:', err);
                resultDiv.innerHTML = '<p style="color:red">ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.</p>';
            } finally {
                loading.style.display = 'none';
            }

            // âœ… JSON ê°ì²´ë¥¼ ì¹´ë“œë·° HTMLë¡œ ë Œë”ë§
            function renderCard(data) {
                const container = document.createElement('div');
                container.style.cssText = `
            background-color: #fff;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 0 8px rgba(0,0,0,0.1);
            margin-top: 30px;
            line-height: 1.6;
        `;

                if (data.goalAnalysis) {
                    const section = document.createElement('section');
                    section.innerHTML = `<h3>ğŸ¯ ëª©í‘œ ë¶„ì„ ë° ì „ëµ</h3><p>${data.goalAnalysis}</p>`;
                    container.appendChild(section);
                }
                if (data.plan7days) {
                    const section = document.createElement('section');
                    section.innerHTML = `<h3>ğŸ“… 7ì¼ ì‹ë‹¨ (ì˜ˆ)</h3><p>${data.plan7days}</p>`;
                    container.appendChild(section);
                }
                if (data.weightChange) {
                    const section = document.createElement('section');
                    section.innerHTML = `<h3>ğŸ“‰ ì˜ˆìƒ ì²´ì¤‘ ë³€í™”</h3><p>${data.weightChange}</p>`;
                    container.appendChild(section);
                }

                const toggle = document.createElement('button');
                toggle.textContent = 'ğŸ“‹ ìì„¸íˆ ë³´ê¸°';
                toggle.style.cssText = `
            margin-top: 20px;
            background-color: #4caf50;
            color: white;
            border: none;
            padding: 10px;
            border-radius: 6px;
            cursor: pointer;
        `;
                const pre = document.createElement('pre');
                pre.style.cssText = 'margin-top: 10px; display: none; white-space: pre-wrap; font-size: 0.85rem; background:#f6f6f6; padding:10px; border-radius:6px; overflow-x:auto;';
                pre.textContent = JSON.stringify(data, null, 2);

                toggle.addEventListener('click', () => {
                    pre.style.display = pre.style.display === 'none' ? 'block' : 'none';
                });

                container.appendChild(toggle);
                container.appendChild(pre);

                resultDiv.innerHTML = '';
                resultDiv.appendChild(container);
            }
        });

    </script>
</body>
</html>
